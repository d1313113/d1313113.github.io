<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>deepClone | Cumelmell blog</title>
    <meta name="description" content="Welcome to my blog">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="preload" href="/assets/css/0.styles.c20c49d1.css" as="style"><link rel="preload" href="/assets/js/app.789f8a5b.js" as="script"><link rel="preload" href="/assets/js/13.7de97acc.js" as="script"><link rel="preload" href="/assets/js/3.423d6eaa.js" as="script"><link rel="prefetch" href="/assets/js/1.0b1c89e1.js"><link rel="prefetch" href="/assets/js/10.7c660df1.js"><link rel="prefetch" href="/assets/js/11.5dcb3e93.js"><link rel="prefetch" href="/assets/js/12.85e40aae.js"><link rel="prefetch" href="/assets/js/14.4afba402.js"><link rel="prefetch" href="/assets/js/15.9ae29113.js"><link rel="prefetch" href="/assets/js/16.58b5f6c5.js"><link rel="prefetch" href="/assets/js/17.e34c373e.js"><link rel="prefetch" href="/assets/js/18.6445b647.js"><link rel="prefetch" href="/assets/js/19.6129ece0.js"><link rel="prefetch" href="/assets/js/20.06776da5.js"><link rel="prefetch" href="/assets/js/21.48a79454.js"><link rel="prefetch" href="/assets/js/22.b597eeb0.js"><link rel="prefetch" href="/assets/js/23.48874c1f.js"><link rel="prefetch" href="/assets/js/24.47152359.js"><link rel="prefetch" href="/assets/js/25.04020dc4.js"><link rel="prefetch" href="/assets/js/26.824b2f1c.js"><link rel="prefetch" href="/assets/js/27.ce21ebfa.js"><link rel="prefetch" href="/assets/js/28.2e9606f3.js"><link rel="prefetch" href="/assets/js/29.eb39c40a.js"><link rel="prefetch" href="/assets/js/4.b9791a1a.js"><link rel="prefetch" href="/assets/js/5.75e40a7c.js"><link rel="prefetch" href="/assets/js/6.facc3a2c.js"><link rel="prefetch" href="/assets/js/7.7a4a997a.js"><link rel="prefetch" href="/assets/js/8.7e8a5e6b.js"><link rel="prefetch" href="/assets/js/9.8221404d.js">
    <link rel="stylesheet" href="/assets/css/0.styles.c20c49d1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-meteorlxy"><header class="header" data-v-7a046aea><div data-v-e4145d0a data-v-7a046aea><nav class="navbar" data-v-e4145d0a><div class="container" data-v-e4145d0a><a href="/" class="router-link-active" data-v-e4145d0a><span class="navbar-site-name" data-v-e4145d0a>
          Cumelmell blog
        </span></a> <div class="navbar-toggler" data-v-e4145d0a><svg class="icon" style="font-size:1.2em;" data-v-e4145d0a data-v-e4145d0a><title data-v-e4145d0a data-v-e4145d0a>menu</title><use xlink:href="#icon-menu" data-v-e4145d0a data-v-e4145d0a></use></svg></div> <div class="navbar-links" data-v-e4145d0a><a href="/" class="navbar-link" data-v-e4145d0a>
            首页
          </a><a href="/posts/" class="navbar-link router-link-active" data-v-e4145d0a>
            文章
          </a><a href="https://github.com/d1313113/d1313113.github.io" target="_blank" rel="noopener noreferrer" class="navbar-link" data-v-e4145d0a><span data-v-e4145d0a>github</span> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound" data-v-e4145d0a data-v-e4145d0a><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav> <div class="navbar-holder" style="display:none;" data-v-e4145d0a></div></div> <div class="banner" data-v-98d6aa8c data-v-7a046aea data-v-7a046aea><div class="container" data-v-98d6aa8c><div class="center" data-v-98d6aa8c><h1 data-v-98d6aa8c data-v-7a046aea>
          deepClone
        </h1></div></div></div></header> <div class="container clearfix show-aside" data-v-4dd605a1 data-v-4dd605a1><main class="main" data-v-4dd605a1><div class="post" data-v-4dd605a1 data-v-4dd605a1><section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2019-11-12
    </span> <span class="update-date" data-v-4e23451f>
      最后修改 : 2020-03-24
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/11/01/_01.html" class="post-link" data-v-4e23451f>
      上一篇 : eslint lint-staged bug修复
    </a> <a href="/posts/2019/11/15/zsh.html" class="post-link" data-v-4e23451f>
      下一篇 : zsh
    </a></section></section> <article class="main-div"><div class="post-content content content__default"><h1 id="js-绕不开的深拷贝"><a href="#js-绕不开的深拷贝" class="header-anchor">#</a> JS 绕不开的深拷贝</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>在<code>JavaScript</code>中深拷贝是一个绕不过的话题,在实际开发中,如果没留心的话,也很容易踩到坑中,下面会由浅入深,一步一步的实现深拷贝.</p> <ul><li>什么是深拷贝</li> <li>什么样的深拷贝才算合格</li> <li>什么样的深拷贝才算优秀</li></ul> <h2 id="深拷贝和浅拷贝的定义"><a href="#深拷贝和浅拷贝的定义" class="header-anchor">#</a> 深拷贝和浅拷贝的定义</h2> <p>浅拷贝:
<img src="/assets/img/2019-11-12-deepClone00.d3f08e44.png" alt="shadowClone"></p> <blockquote><p>创建一个新的对象,这个对象有着对原始对象的一份精确拷贝.</p> <p>如果拷贝的属性属于基本类型的话,拷贝的就是这个基本类型的值,例如字符串,数字等.</p> <p>如果拷贝的是属性是引用类型,则拷贝的是内存地址,当其中任意一个修改属性,<strong>会相互影响</strong>.例如对象,数组等.</p></blockquote> <p>深拷贝:
<img src="/assets/img/2019-11-12-deepClone01.a4c10361.png" alt="deepClone"></p> <blockquote><p>将一个对象完整的从内存中拷贝一份,并在堆内存中开辟一个新的区域来存放,修改新/旧对象均不会<strong>相互影响</strong>.</p></blockquote> <h2 id="最易版"><a href="#最易版" class="header-anchor">#</a> 最易版</h2> <p>在<code>JavaScript</code>中,不借助第三方库情况下,最简单及最常用的是如下<code>api</code></p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token keyword">let</span> obj1 <span class="token operator">=</span> <span class="token punctuation">{</span>
  a<span class="token operator">:</span> <span class="token punctuation">{</span>
    b<span class="token operator">:</span> <span class="token number">123</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> obj2 <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj1<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>借助这个<code>api</code>就可以应对大部分使用深拷贝的场景了,不过也存在一些问题</p> <h3 id="存在的问题"><a href="#存在的问题" class="header-anchor">#</a> 存在的问题</h3> <ol><li>无法处理对象循环引用</li> <li>无法序列化正则,Error等,序列化结果只能得到一个空对象</li> <li>函数,<code>undefined</code>会丢失</li> <li><code>NaN, Infinity, -Infinity</code>序列化结果会变成<code>null</code></li> <li>序列化<code>Date</code>对象得到的是字符串形式的日期格式,而非时间对象</li> <li>只能序列化自身可枚举的自有属性,如果有属性是通过构造函数生成的,在序列化后会丢失属性的<code>construtor</code></li></ol> <h2 id="基础版本"><a href="#基础版本" class="header-anchor">#</a> 基础版本</h2> <p>稍作思考,一个基础版本的深拷贝应该支持</p> <ul><li>多层不确定嵌套深度的对象拷贝</li> <li>针对基础类型直接拷贝</li> <li>如果是引用类型,创建一个新的对象,遍历需要拷贝的对象,将属性依次<strong>深拷贝</strong>到新对象上</li></ul> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneTarge <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 递归调用deepClone函数处理深层嵌套对象</span>
      cloneTarge<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 处理基础类型直接返回值</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>尝试对如下的代码进行测试</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  key1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  key2<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key3<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
  key4<span class="token operator">:</span> <span class="token punctuation">{</span>
    child1<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
    child2<span class="token operator">:</span> <span class="token punctuation">{</span>
      child21<span class="token operator">:</span> <span class="token string">'child21'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>测试结果:
<img src="/assets/img/2019-11-12-deepClone02.c7588930.png" alt="test1"></p> <p>这是一个最基础的深拷贝的版本,不过还有很多问题没有处理,接下来处理数组</p> <h2 id="考虑数组版本"><a href="#考虑数组版本" class="header-anchor">#</a> 考虑数组版本</h2> <p>在基础版本中,只处理的普通的<code>Object</code>,接下来把代码稍微改动一下,就可以处理数组的情况.</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneTarge <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cloneTarge<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>依旧跑一下测试代码</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  key1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  key2<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key3<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
  key4<span class="token operator">:</span> <span class="token punctuation">{</span>
    child1<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
    child2<span class="token operator">:</span> <span class="token punctuation">{</span>
      child21<span class="token operator">:</span> <span class="token string">'child21'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    child3<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>测试结果:
<img src="/assets/img/2019-11-12-deepClone03.5b477d5c.png" alt="test2"></p> <h2 id="循环引用"><a href="#循环引用" class="header-anchor">#</a> 循环引用</h2> <p>循环引用是对象的属性引用自身属性情况下出现的,举个例子.</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br></div><pre class="language-js"><code><span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  key1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  key2<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key3<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
  key4<span class="token operator">:</span> <span class="token punctuation">{</span>
    child1<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
    child2<span class="token operator">:</span> <span class="token punctuation">{</span>
      child21<span class="token operator">:</span> <span class="token string">'child21'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    child3<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 对象引用自身属性</span>
target<span class="token punctuation">.</span>key5 <span class="token operator">=</span> target<span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>当前写的深拷贝处理不了循环引用,导致递归爆栈了
<img src="/assets/img/2019-11-12-deepClone04.55253778.png" alt="test3">
为了解决循环引用的问题,可以使用一个<code>cache</code>来存储当前对象和拷贝对象的对应关系,拷贝时先去<code>cache</code>中查找,命中的话就直接返回<code>cache</code>内容,未命中才去创建.</p> <p>这个<code>cache</code>是<code>key: value</code>的形式,可以选择<code>ES6</code>中的<code>Map</code>数据结构</p> <p>处理的步骤如下:</p> <p><img src="/assets/img/2019-11-12-deepClone05.739032ea.png" alt="test3"></p> <p>修改代码后:</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> cloneTarge <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// 是否命中cache</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 未命中cache,将当前数据缓存起来</span>
    cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> cloneTarge<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      cloneTarge<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>重新运行代码,发现箭头处成了<code>Circular</code>,处理循环引用完成.
<img src="/assets/img/2019-11-12-deepClone06.251ea740.png" alt="test4"></p> <p>采用<code>WeakMap</code>代替<code>Map</code>,让<code>cache</code>的数据可以被垃圾回收机制回收</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ......</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="其他数据类型"><a href="#其他数据类型" class="header-anchor">#</a> 其他数据类型</h2> <h3 id="引用类型判断"><a href="#引用类型判断" class="header-anchor">#</a> 引用类型判断</h3> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// helper</span>
<span class="token keyword">function</span> <span class="token function">isObject</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token keyword">typeof</span> target<span class="token punctuation">;</span>
  <span class="token keyword">return</span> target <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">||</span> type <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="获取数据类型"><a href="#获取数据类型" class="header-anchor">#</a> 获取数据类型</h3> <p>可以借用<code>toString</code>方法来获取数据类型.</p> <blockquote><p>在每一个引用数据类型的原型上都拥有<code>toString</code>方法,<code>toString</code>方法会被每个对象继承,</p> <p>如果该方法没有被重写的话,调用<code>toString()</code>会返回<code>[object type]</code>,其中type为对象的类型</p></blockquote> <p>PS:只有当该方法没有被重写时才会有预期的效果,但实际上大部分的引用类型的<code>toString</code>方法都被重写了,例如<code>Array,Date,RegExp</code>等.</p> <p>不过可以通过调用原始的<code>Object</code>原型上未被重写的<code>toString</code>来获取对象的类型.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getType</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><table><thead><tr><th style="text-align:left;">调用</th> <th style="text-align:left;">结果</th></tr></thead> <tbody><tr><td style="text-align:left;">Object.prototype.toString.call(true)</td> <td style="text-align:left;">[object Boolean]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(123)</td> <td style="text-align:left;">[object Number]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call('123')</td> <td style="text-align:left;">[object String]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(null)</td> <td style="text-align:left;">[object Null]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(undefined)</td> <td style="text-align:left;">[object Undefined]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(Symbol())</td> <td style="text-align:left;">[object Symbol]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call({})</td> <td style="text-align:left;">[object Object]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(function() {})</td> <td style="text-align:left;">[object Function]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call([])</td> <td style="text-align:left;">[object Array]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new Error())</td> <td style="text-align:left;">[object Error]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new RegExp())</td> <td style="text-align:left;">[object RegExp]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(Math)</td> <td style="text-align:left;">[object Math]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(JSON)</td> <td style="text-align:left;">[object JSON]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new Date())</td> <td style="text-align:left;">[object Date]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new Map())</td> <td style="text-align:left;">[object Map]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new Set())</td> <td style="text-align:left;">[object Set]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(new document())</td> <td style="text-align:left;">[object RegExp]</td></tr> <tr><td style="text-align:left;">Object.prototype.toString.call(window)</td> <td style="text-align:left;">[object global]</td></tr></tbody></table> <p>抽取部分常用的数据类型</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">const</span> mapTag <span class="token operator">=</span> <span class="token string">'[object Map]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> setTag <span class="token operator">=</span> <span class="token string">'[object Set]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> arrayTag <span class="token operator">=</span> <span class="token string">'[object Array]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> objectTag <span class="token operator">=</span> <span class="token string">'[object Object]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> boolTag <span class="token operator">=</span> <span class="token string">'[object Boolean]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> dateTag <span class="token operator">=</span> <span class="token string">'[object Boolean]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> errorTag <span class="token operator">=</span> <span class="token string">'[object Error]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> numberTag <span class="token operator">=</span> <span class="token string">'[object Number]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> regexpTag <span class="token operator">=</span> <span class="token string">'[object RegExp]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> stringTag <span class="token operator">=</span> <span class="token string">'[object String]'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> symbolTag <span class="token operator">=</span> <span class="token string">'[object Symbol]'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>在上述的几种类型中,先简单的区分成两类</p> <ul><li>可继续遍历的类型</li> <li>不可继续遍历的类型
针对不同的类型做不同的拷贝处理</li></ul> <h3 id="可继续遍历类型"><a href="#可继续遍历类型" class="header-anchor">#</a> 可继续遍历类型</h3> <ol><li>Object</li> <li>Array</li> <li>Map</li> <li>Set</li></ol> <p>有序的类型继续递归,首先需要获取它的初始化数据,例如上述的<code>[]</code>和<code>{}</code>,可以通过拿到<code>constructor</code>的方式来获取.</p> <p>例如：<code>const target = {}</code>就是<code>const target = new Object()</code>的语法糖。另外这种方法还有一个好处：因为我们还使用了原对象的构造方法，所以它可以保留对象原型上的数据，如果直接使用普通的<code>{}</code>，那么原型必然是丢失了的。</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">getInit</span><span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Ctor <span class="token operator">=</span> target<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>改写<code>deepClone</code>函数,对可继续遍历数据类型处理.</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br></div><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">deepClone</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> cache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 处理原始数据类型</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isObject</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> target<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 初始化</span>
  <span class="token keyword">const</span> type <span class="token operator">=</span> <span class="token function">getType</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deepTag<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cloneTarge <span class="token operator">=</span> <span class="token function">getInit</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> type<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  cache<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> cloneTarge<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 拷贝set</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> setTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">val</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      cloneTarge<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 拷贝map</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> mapTag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    target<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">val<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      cloneTarge<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>val<span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 拷贝对象和数组</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    cloneTarge<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">deepClone</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> cache<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> cloneTarge<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div><p>测试代码:</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'dceee'</span><span class="token punctuation">,</span> <span class="token string">'vvvvvv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'CorDDDD'</span><span class="token punctuation">,</span> <span class="token string">'CODONeNNN飞'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'dceee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'CODONeNNN飞'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  key1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  key2<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key3<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
  key4<span class="token operator">:</span> <span class="token punctuation">{</span>
    child1<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
    child2<span class="token operator">:</span> <span class="token punctuation">{</span>
      child21<span class="token operator">:</span> <span class="token string">'child21'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    child3<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  key5<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  map<span class="token punctuation">,</span>
  <span class="token keyword">set</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div><p>测试代码深拷贝成功
<img src="/assets/img/2019-11-12-deepClone07.0442a561.png" alt="test5"></p> <h3 id="不可继续遍历的类型"><a href="#不可继续遍历的类型" class="header-anchor">#</a> 不可继续遍历的类型</h3> <p>其他的类型都归类到不可处理的数据类型中,下面以及进行处理:</p> <p><code>Boolean, Number, String, Date, Error</code>这几种类型可以直接使用构造函数和原始数据创建新对象出来.</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cloneOtherType</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> type</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> Ctor <span class="token operator">=</span> target<span class="token punctuation">.</span>constructor<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> boolTag<span class="token operator">:</span>
    <span class="token keyword">case</span> numberTag<span class="token operator">:</span>
    <span class="token keyword">case</span> stringTag<span class="token operator">:</span>
    <span class="token keyword">case</span> errorTag<span class="token operator">:</span>
    <span class="token keyword">case</span> dateTag<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Ctor</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> regexpTag<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">cloneReg</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> symbolTag<span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token function">cloneSymbol</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>单独处理<code>Symbol, RegExp</code></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">cloneSymbol</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token class-name">Symbol</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">cloneReg</span> <span class="token punctuation">(</span><span class="token parameter">target</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> regFlags <span class="token operator">=</span> <span class="token regex">/\w*$/</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">target<span class="token punctuation">.</span>constructor</span><span class="token punctuation">(</span>target<span class="token punctuation">.</span>source<span class="token punctuation">,</span> regFlags<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  res<span class="token punctuation">.</span>lastIndex <span class="token operator">=</span> target<span class="token punctuation">.</span>lastIndex<span class="token punctuation">;</span>
  <span class="token keyword">return</span> res<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>到这时,已经可以处理大部分的数据类型,执行下测试代码</p> <div class="language-js line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code><span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'dceee'</span><span class="token punctuation">,</span> <span class="token string">'vvvvvv'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">'CorDDDD'</span><span class="token punctuation">,</span> <span class="token string">'CODONeNNN飞'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token keyword">set</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'dceee'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">set</span><span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">'CODONeNNN飞'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> target <span class="token operator">=</span> <span class="token punctuation">{</span>
  key1<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  key2<span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
  key3<span class="token operator">:</span> <span class="token string">'abc'</span><span class="token punctuation">,</span>
  key4<span class="token operator">:</span> <span class="token punctuation">{</span>
    child1<span class="token operator">:</span> <span class="token string">'child1'</span><span class="token punctuation">,</span>
    child2<span class="token operator">:</span> <span class="token punctuation">{</span>
      child21<span class="token operator">:</span> <span class="token string">'child21'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    child3<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  key5<span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
  map<span class="token punctuation">,</span>
  <span class="token keyword">set</span><span class="token punctuation">,</span>
  bool<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  num<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
  str<span class="token operator">:</span> <span class="token string">'123'</span><span class="token punctuation">,</span>
  symbol<span class="token operator">:</span> <span class="token function">Object</span><span class="token punctuation">(</span><span class="token function">Symbol</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  date<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  reg<span class="token operator">:</span> <span class="token regex">/\d+/</span><span class="token punctuation">,</span>
  error<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br></div></div><p>顺利通过.
<img src="/assets/img/2019-11-12-deepClone08.40375985.png" alt="test6"></p></div></article> <section class="post-meta main-div" data-v-4e23451f><section class="post-date clearfix" data-v-4e23451f><span class="create-date" data-v-4e23451f>
      发布时间 : 2019-11-12
    </span> <span class="update-date" data-v-4e23451f>
      最后修改 : 2020-03-24
    </span></section> <section class="post-links" data-v-4e23451f><a href="/posts/2019/11/01/_01.html" class="post-link" data-v-4e23451f>
      上一篇 : eslint lint-staged bug修复
    </a> <a href="/posts/2019/11/15/zsh.html" class="post-link" data-v-4e23451f>
      下一篇 : zsh
    </a></section></section> <!----></div></main> <aside class="aside" data-v-4dd605a1><div class="info-card main-div" data-v-9d847660 data-v-4dd605a1><div class="info-card-header" data-v-9d847660><img src="/images/common/avatar.jpg" alt="Cumelmell" class="info-avatar" data-v-9d847660></div> <div class="info-card-body" data-v-9d847660><section class="info-nickname" data-v-9d847660>
      Cumelmell
    </section> <section class="info-desc" data-v-9d847660>Just Enjoy Coding</section> <section class="info-contact" data-v-9d847660><section data-v-9d847660><span title="China" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>China</title><use xlink:href="#icon-location" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          China
        </span></span></section> <!----> <section data-v-9d847660><a href="mailto:cumelmell@foxmail.com" title="cumelmell@foxmail.com" data-v-9d847660 data-v-9d847660><svg class="icon" style="font-size:1em;" data-v-9d847660 data-v-9d847660><title data-v-9d847660 data-v-9d847660>cumelmell@foxmail.com</title><use xlink:href="#icon-email" data-v-9d847660 data-v-9d847660></use></svg><span class="info-text" data-v-9d847660 data-v-9d847660>
          cumelmell@foxmail.com
        </span></a></section></section></div> <!----></div> <div class="post-nav-card main-div" style="position:relative;top:0;width:0px;" data-v-4dd605a1><div class="post-nav-contents"><svg class="icon"><title>book</title><use xlink:href="#icon-book"></use></svg> <span></span> <div class="post-nav-toc"><ul><li><a href="/posts/2019/11/12/deepclone.html#前言">前言</a></li><li><a href="/posts/2019/11/12/deepclone.html#深拷贝和浅拷贝的定义">深拷贝和浅拷贝的定义</a></li><li><a href="/posts/2019/11/12/deepclone.html#最易版">最易版</a><ul><li><a href="/posts/2019/11/12/deepclone.html#存在的问题">存在的问题</a></li></ul></li><li><a href="/posts/2019/11/12/deepclone.html#基础版本">基础版本</a></li><li><a href="/posts/2019/11/12/deepclone.html#考虑数组版本">考虑数组版本</a></li><li><a href="/posts/2019/11/12/deepclone.html#循环引用">循环引用</a></li><li><a href="/posts/2019/11/12/deepclone.html#其他数据类型">其他数据类型</a><ul><li><a href="/posts/2019/11/12/deepclone.html#引用类型判断">引用类型判断</a></li><li><a href="/posts/2019/11/12/deepclone.html#获取数据类型">获取数据类型</a></li><li><a href="/posts/2019/11/12/deepclone.html#可继续遍历类型">可继续遍历类型</a></li><li><a href="/posts/2019/11/12/deepclone.html#不可继续遍历的类型">不可继续遍历的类型</a></li></ul></li></ul></div></div> <!----></div></aside></div> <footer class="footer" data-v-1375e54c><!----> <!----> <p class="footer-text" data-v-1375e54c>Copyright 2019-present <a href="https://github.com/d1313113" target="_blank">Cumelmell</a> | MIT License</p></footer></div><div class="global-ui"><!----><!----><div class="cat-container" data-v-a13867c0><canvas id="vuepress-cat" width="280" height="250" class="live2d" data-v-a13867c0></canvas></div></div></div>
    <script src="/assets/js/app.789f8a5b.js" defer></script><script src="/assets/js/13.7de97acc.js" defer></script><script src="/assets/js/3.423d6eaa.js" defer></script>
  </body>
</html>
